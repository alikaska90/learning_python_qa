# Описание работы log_script.py

## Основное

Данный скрипт выполняет анализ log файлов и собирает по ним отчет со следующей информацией:
- общее количество запросов по всем файлам;
- количество запросов по каждому типу запроса;
- топ 3 IP адреса, с которых было выполнено наибольшее количество запросов;
- топ 3 самых длительных запросов.

## Запуск

При запуске log_script.py можно передать путь к файлу с логами или путь до директории, где лежат файлы для обработки.
Если путь к файлам не был передан, по умолчанию используется папка logs данного проекта.
Пример вызова:
```
python3 log_script.py <путь к файлу / директории с файлами>
```

## Описание работы скрипта

Алгоритм состоит из следующих логических частей:
- сбор и преобразование данных;
- подготовка и вывод отчета.

В программе реализованы следующие основные методы:

Расположены в файле log_script.py

### create_report

1. Создает список лог файлов для обработки;
1. Получает данные для будущего репорта с помощью метода log_files_parser;
1. Собирает отчет на основе полученных данных;
1. Записывает отчет в файл формата json;
1. Выводит отчет в терминал.

### log_files_parser

На вход принимает спиок путей к файлам для обработки.

1. Проходится по всем строкам файлов, преобразуя каждую в словарь с помощью метода log_string_parser;
1. Все обработанные строки добавляет в список;
1. Создает словарь с IP адресами и количеством запросов с этих адресов для получения топ 3 IP адресов.

Возвращает кортеж со списком обработанных строк и словарем IP адресов

### get_request_count_by_request_type

На вход принимает список обработанных строк.

1. Подсчитывает количество сделанных запросов по всем возможным типам запросов;
1. Создает словарь на основе полученных данных.

Возвращает словарь типов запросов.

### report_template

Шаблон отчета для вывода в терминал.
На вход принимает сформированный отчет из метода create_report.

1. Преобразует отчет в соответствии с шаблоном.

Возвращает строку с отчетом для вывода в терминал.


Вспомогательные методы для преобразования типов данных:

Расположены в файле srv/common.py

### filter_by_dict_key_and_value

На вход принимает список словарей, ключ и значение словаря.

1. Отбирает все словари по переданным ключу и значению.

Возвращает отфильтрованный список словарей.

### sort_dicts_by_key

На вход принимает список словарей и ключ, по которому будут сортироваться элементы.
Если необходимо отсортировать список в обратном порядке, необходимо также передать аргумент reverse со значением True.

1. Сортирует список словарей по значению с переданным ключом.

Возвращает отсортированный список словарей.

### sort_dict_by_value

На вход принимает словарь.
Если необходимо отсортировать список в обратном порядке, необходимо также передать аргумент reverse со значением True.

1. Сортирует словарь по значению.

Возвращает список кортежей с парой ключ и значение.

### convert_tuple_list_to_dict_list

На вход принимает список кортежей со значениями и список ключей для будущего словаря.

1. Преобразует значения и ключи в словарь, добавляя этот словарь в список.

Возвращает полученный список словарей.

## Вывод

Отчет сохраняется в файл с наименованием: log_report_<текущая дата и время>.json в следующем формате:
```
{
    "num_of_req": <общее количество запросов по всем обработанным файлам>,
    "num_of_req_by_req_type": {
        <тип запроса>: <количество запросов данного типа>,
        ...
    },
    "top_3_ips": [
        {
            "ip": <IP адрес> ,
            "count": <количество запросов, выполенных с этого IP>
        },
        ...
    ],
    "top_3_long_req": [
        {
            "req_type": <тип запроса>,
            "url": <urt>,
            "ip": <IP адрес>,
            "exec_time": <длительность запроса>,
            "date": <дата и время выполнения запроса>
        },
        ...
    ]
}
```

Также отчет выводится в терминал в следущющем формате:
```
Num of requests: <общее количество запросов по всем обработанным файлам>
Num of requests by request types:
| REQ TYPE | NUM OF REQs |
| <тип запроса> | <количество запросов данного типа> |
...
TOP 3 IPs:
| IP | NUM OF REQs |
| <IP адрес> | <количество запросов, выполенных с этого IP> |
...
TOP 3 long-running requests:
| REQ TYPE | URL | IP | EXEC TIME | DATE |
| <тип запроса> | <urt> | <IP адрес> | <длительность запроса> | <дата и время выполнения запроса> |
...
```
